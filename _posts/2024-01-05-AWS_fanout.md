---
layout: post
title: LocalStackμΌλ΅ κµ¬ν„ν•λ” AWS SNS λ©”μ‹μ§€ ν•„ν„°λ§ μ‹μ¤ν…
date: 2024-01-05 00:00:00 +0900
description: LocalStackκ³Ό AWS SNS MessageAttributesλ¥Ό ν™μ©ν•΄ μƒ‰μƒλ³„, μ΅°κ±΄λ³„λ΅ λ©”μ‹μ§€λ¥Ό ν•„ν„°λ§ν•λ” Fan-out ν¨ν„΄ κµ¬ν„ν•κΈ°
img: 2024-01-05/fanout.png
tags: [AWS, SNS, SQS, LocalStack, MessageFiltering, Microservices]
---

# LocalStackμΌλ΅ κµ¬ν„ν•λ” AWS SNS λ©”μ‹μ§€ ν•„ν„°λ§ μ‹μ¤ν…

λ§μ΄ν¬λ΅μ„λΉ„μ¤ μ•„ν‚¤ν…μ²μ—μ„ μ„λΉ„μ¤ κ°„ λ©”μ‹μ§€ μ „λ‹¬μ€ ν•µμ‹¬μ μΈ μ”μ†μ…λ‹λ‹¤. νΉν ν•λ‚μ μ΄λ²¤νΈλ¥Ό μ—¬λ¬ μ„λΉ„μ¤μ— μ „λ‹¬ν•λ, κ° μ„λΉ„μ¤κ°€ ν•„μ”ν• λ©”μ‹μ§€λ§ λ°›λ„λ΅ ν•λ” κ²ƒμ€ ν¨μ¨μ„±κ³Ό μ„±λ¥ μΈ΅λ©΄μ—μ„ λ§¤μ° μ¤‘μ”ν•©λ‹λ‹¤.

μ¤λμ€ AWS SNSμ λ©”μ‹μ§€ ν•„ν„°λ§ κΈ°λ¥μ„ ν™μ©ν•΄ μƒ‰μƒλ³„, μ΅°κ±΄λ³„λ΅ λ©”μ‹μ§€λ¥Ό λΌμ°ν…ν•λ” μ‹μ¤ν…μ„ LocalStackμΌλ΅ κµ¬ν„ν•΄λ³΄κ² μµλ‹λ‹¤.

## ν”„λ΅μ νΈ λ©ν‘

λ‹¤μκ³Ό κ°™μ€ μ”κµ¬μ‚¬ν•­μ„ κ°€μ§„ λ©”μ‹μ§€ ν•„ν„°λ§ μ‹μ¤ν…μ„ κµ¬ν„ν•©λ‹λ‹¤:

1. **ColorQueue**: λ¨λ“  μƒ‰μƒ(blue, red, yellow, green) λ©”μ‹μ§€ μμ‹ 
2. **BlueYellowQueue**: blueμ™€ yellow λ©”μ‹μ§€λ§ μμ‹ 
3. **RedQueue**: red λ©”μ‹μ§€λ§ μμ‹ 
4. **GreenHighQueue**: green λ©”μ‹μ§€ μ¤‘ quantity κ°’μ΄ 100 μ΄μƒμΈ λ©”μ‹μ§€λ§ μμ‹ 
5. **GreenLowQueue**: green λ©”μ‹μ§€ μ¤‘ quantity κ°’μ΄ 100 λ―Έλ§μΈ λ©”μ‹μ§€λ§ μμ‹ 

## κΈ°μ  μ¤νƒ

- **AWS SNS**: λ©”μ‹μ§€ λ°ν–‰ λ° ν•„ν„°λ§
- **AWS SQS**: λ©”μ‹μ§€ νμ‰
- **LocalStack**: λ΅μ»¬ AWS ν™κ²½ μ‹λ®¬λ μ΄μ…
- **Node.js**: λ©”μ‹μ§€ λ°μ†΅ λ° μμ‹  λ΅μ§
- **AWS SDK v3**: JavaScriptμ© AWS ν΄λΌμ΄μ–ΈνΈ

## μ•„ν‚¤ν…μ² μ„¤κ³„

```
SNS Topic (sample-topic)
β”β”€β”€ ColorQueue (λ¨λ“  μƒ‰μƒ)
β”β”€β”€ BlueYellowQueue (blue, yellow)
β”β”€β”€ RedQueue (red only)
β”β”€β”€ GreenHighQueue (green + quantity κ°’β‰¥100)
β””β”€β”€ GreenLowQueue (green + quantity κ°’<100)
```

## LocalStack ν™κ²½ μ„¤μ •

λ¨Όμ € LocalStack ν™κ²½μ„ κµ¬μ„±ν•κ³  ν•„μ”ν• νμ™€ κµ¬λ…μ„ μ„¤μ •ν•©λ‹λ‹¤.

<a href="https://github.com/seongjin605/aws-fanout-pattern/blob/main/localstack.sh" target="_blank">π”— localstack.sh</a>

## ν•µμ‹¬ κ°λ…: SNS FilterPolicy

AWS SNSμ ν•„ν„° μ •μ±…μ€ κµ¬λ…μκ°€ λ°›κ³  μ‹¶μ€ λ©”μ‹μ§€λ¥Ό μ„ νƒμ μΌλ΅ μμ‹ ν•  μ μκ² ν•΄μ£Όλ” κΈ°λ¥μ…λ‹λ‹¤.

### 1. κΈ°λ³Έ λ¬Έμμ—΄ ν•„ν„°λ§

```json
{ "color": ["blue", "yellow"] }
```

### 2. μ«μ μ΅°κ±΄ ν•„ν„°λ§

> μ•½μ†ν• quantityλΌλ” κ°’μ„ μ§€μ •ν•μ—¬ ν•„ν„°λ§μ„ μ„¤μ •ν•©λ‹λ‹¤.

```json
{ "color": ["green"], "quantity": [{ "numeric": [">=", 100] }] }
```

μ΄ ν•„ν„°λ” λ©”μ‹μ§€ μ†μ„±μ `quantity` κ°’μ΄ 100 μ΄μƒμΈ green λ©”μ‹μ§€λ§ ν—μ©ν•©λ‹λ‹¤.

### μ£Όμ” μ«μ μ—°μ‚°μ

- `=`: κ°™μ
- `>`: μ΄κ³Ό
- `>=`: μ΄μƒ
- `<`: λ―Έλ§
- `<=`: μ΄ν•

## λ©”μ‹μ§€ λ°μ†΅ λ° μμ‹  λ΅μ§

### ν•µμ‹¬ κΈ°λ¥

#### 1. MessageAttributesλ¥Ό ν¬ν•¨ν• SNS λ©”μ‹μ§€ λ°μ†΅

SNS λ©”μ‹μ§€λ¥Ό λ°μ†΅ν•  λ•λ” `MessageAttributes`λ¥Ό ν†µν•΄ ν•„ν„°λ§μ— μ‚¬μ©ν•  μ†μ„±λ“¤μ„ ν•¨κ» μ „μ†΅ν•©λ‹λ‹¤. μ΄ μ†μ„±λ“¤μ€ λ©”μ‹μ§€ λ³Έλ¬Έκ³Όλ” λ³„κ°λ΅ κ΄€λ¦¬λμ–΄ ν•„ν„°λ§ μ„±λ¥μ„ ν–¥μƒμ‹ν‚µλ‹λ‹¤.

ν•µμ‹¬μ€ `color`μ™€ `quantity` μ†μ„±μ„ MessageAttributesμ— ν¬ν•¨μ‹ν‚¤λ” κ²ƒμ…λ‹λ‹¤:

```javascript
const messageAttributes = {
  color: {
    DataType: 'String',
    StringValue: color
  }
};

// quantityκ°€ μ κ³µλλ©΄ MessageAttributesμ— μ¶”κ°€
if (quantity) {
  messageAttributes.quantity = {
    DataType: 'Number',
    StringValue: quantity.toString()
  };
}
```

μ΄λ ‡κ² μ„¤μ •λ μ†μ„±λ“¤μ€ SNS ν•„ν„° μ •μ±…μ—μ„ μ΅°κ±΄μΌλ΅ μ‚¬μ©λ©λ‹λ‹¤.

#### 2. ν–¥μƒλ SQS λ©”μ‹μ§€ μμ‹ 

SQSμ—μ„ λ©”μ‹μ§€λ¥Ό μμ‹ ν•  λ•λ” `MessageAttributeNames: ['All']` μµμ…μ„ μ‚¬μ©ν•μ—¬ λ¨λ“  λ©”μ‹μ§€ μ†μ„±μ„ ν•¨κ» κ°€μ Έμµλ‹λ‹¤. μ΄λ¥Ό ν†µν•΄ μ–΄λ–¤ μ†μ„±μΌλ΅ ν•„ν„°λ§λμ—λ”μ§€ ν™•μΈν•  μ μμµλ‹λ‹¤.(<a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/APIReference/API_ReceiveMessage.html#API_ReceiveMessage_RequestParameters" target="_blank">π”— AWS Request Parameters μ°Έμ΅°</a>)

μμ‹ λ λ©”μ‹μ§€λ” SNSλ¥Ό ν†µν•΄ μ „λ‹¬λ κ²ƒμ΄λ―€λ΅ JSON ν•νƒλ΅ νμ‹±ν•μ—¬ μ‹¤μ  λ©”μ‹μ§€ λ‚΄μ©κ³Ό μ†μ„±λ“¤μ„ ν™•μΈν•©λ‹λ‹¤:

```javascript
const snsMessage = JSON.parse(message.Body);
console.log(`μ‹¤μ  λ©”μ‹μ§€: ${snsMessage.Message}`);

// MessageAttributes μ¶λ ¥
if (snsMessage.MessageAttributes) {
  Object.entries(snsMessage.MessageAttributes).forEach(([key, value]) => {
    console.log(`  - ${key}: ${value.Value} (νƒ€μ…: ${value.Type})`);
  });
}
```

μ΄λ¥Ό ν†µν•΄ κ° νκ°€ μ¬λ°”λ¥Έ ν•„ν„° μ΅°κ±΄μΌλ΅ λ©”μ‹μ§€λ¥Ό μμ‹ ν–λ”μ§€ κ²€μ¦ν•  μ μμµλ‹λ‹¤.

## ν…μ¤νΈ μ‹λ‚λ¦¬μ¤

ν•„ν„°λ§ μ‹μ¤ν…μ μ •ν™•μ„±μ„ κ²€μ¦ν•κΈ° μ„ν•΄ λ‹¤μ–‘ν• μ΅°κ±΄μ λ©”μ‹μ§€λ¥Ό μ „μ†΅ν•©λ‹λ‹¤. μ΄ 8κ°μ ν…μ¤νΈ λ©”μ‹μ§€λ¥Ό μ‚¬μ©ν•μ—¬ κ° νμ ν•„ν„°λ§ λ΅μ§μ„ κ²€μ¦ν•©λ‹λ‹¤:

- **κΈ°λ³Έ μƒ‰μƒ λ©”μ‹μ§€**: blue, red, yellow (κ° 1κ°μ”©) β΅οΈ λ©”μ‹μ§€ **3κ°** μ „μ†΅
- **Green λ©”μ‹μ§€ (quantity κ°’λ³„)**: quantity=50(μ μ€ κ°’), quantity=150(ν° κ°’), quantity=100(κ²½κ³„κ°’) β΅οΈ λ©”μ‹μ§€ **3κ°** μ „μ†΅
- **Blue/Yellow & quantity μ΅°ν•© λ©”μ‹μ§€**: blue(quantity=75), yellow(quantity=200) β΅οΈ λ©”μ‹μ§€ **2κ°** μ „μ†΅

μ΄λ¬ν• λ‹¤μ–‘ν• μ΅°ν•©μ„ ν†µν•΄ κ° νμ ν•„ν„° μ΅°κ±΄μ΄ μ •ν™•ν μ‘λ™ν•λ”μ§€ ν™•μΈν•  μ μμµλ‹λ‹¤.

## ν…μ¤νΈ κ²°κ³Ό

μ‹¤μ  ν…μ¤νΈλ¥Ό μ‹¤ν–‰ν• κ²°κ³Ό, ν•„ν„°λ§μ΄ μ •ν™•ν•κ² μ‘λ™ν•¨μ„ ν™•μΈν–μµλ‹λ‹¤:
![color_fanout]({{site.baseurl}}/assets/img/2024-01-05/color_fanout.png)

| ν μ΄λ¦„             | μμƒ λ©”μ‹μ§€ μ | μμ‹ ν•  λ©”μ‹μ§€           | ν•„ν„° μ΅°κ±΄                                                 |
| ------------------- | -------------- | ----------------------- | --------------------------------------------------------- |
| **ColorQueue**      | 8κ°            | λ¨λ“  μƒ‰μƒ λ©”μ‹μ§€        | `{"color":["blue","red","yellow","green"]}`               |
| **BlueYellowQueue** | 4κ°            | blue, yellow λ©”μ‹μ§€λ§   | `{"color":["blue","yellow"]}`                             |
| **RedQueue**        | 1κ°            | red λ©”μ‹μ§€λ§            | `{"color":["red"]}`                                       |
| **GreenHighQueue**  | 2κ°            | green + quantity κ°’β‰¥100 | `{"color":["green"],"quantity":[{"numeric":[">=",100]}]}` |
| **GreenLowQueue**   | 1κ°            | green + quantity κ°’<100 | `{"color":["green"],"quantity":[{"numeric":["<",100]}]}`  |

### μƒμ„Έ κ²°κ³Ό λ¶„μ„

1. **ColorQueue**: 8κ° λ©”μ‹μ§€ λ¨λ‘ μμ‹ 
2. **BlueYellowQueue**: Blue(2κ°) + Yellow(2κ°) = 4κ° μμ‹ 
3. **RedQueue**: Red λ©”μ‹μ§€ 1κ°λ§ μμ‹ 
4. **GreenHighQueue**: Green(quantity=150), Green(quantity=100) = 2κ° μμ‹ 
5. **GreenLowQueue**: Green(quantity=50) = 1κ° μμ‹ 

## μ‹¤ν–‰ λ°©λ²•

ν”„λ΅μ νΈλ¥Ό μ‹¤ν–‰ν•λ” λ°©λ²•μ€ λ‹¤μκ³Ό κ°™μµλ‹λ‹¤:

1. **ν™κ²½ μ„¤μ •**: `./localstack.sh` λ…λ Ήμ–΄λ΅ LocalStack ν™κ²½μ„ κµ¬μ„±ν•©λ‹λ‹¤.
2. **μ „μ²΄ ν…μ¤νΈ**: `node fanout.js`λ΅ λ¨λ“  νλ¥Ό μ •λ¦¬ν• ν›„ μ „μ²΄ ν…μ¤νΈλ¥Ό μ‹¤ν–‰ν•©λ‹λ‹¤.
3. **νΉμ • ν ν™•μΈ**: `node fanout.js ColorQueue`μ™€ κ°™μ΄ νΉμ • νλ§ ν™•μΈν•  μ μμµλ‹λ‹¤.
4. **ν μ •λ¦¬ ν›„ ν™•μΈ**: `node fanout.js ColorQueue clear`λ΅ νΉμ • νλ¥Ό μ •λ¦¬ν• ν›„ ν™•μΈν•©λ‹λ‹¤.
5. **μ „μ²΄ μ •λ¦¬**: `node fanout.js clear`λ΅ λ¨λ“  νλ¥Ό μ •λ¦¬ν•©λ‹λ‹¤.

μ΄λ¬ν• λ‹¤μ–‘ν• μ‹¤ν–‰ μµμ…μ„ ν†µν•΄ κ°λ° κ³Όμ •μ—μ„ ν•„μ”ν• λ¶€λ¶„λ§ μ„ νƒμ μΌλ΅ ν…μ¤νΈν•  μ μμµλ‹λ‹¤.

## μ£Όμ” ν•™μµ ν¬μΈνΈ

### 1. MessageAttributesμ μ¤‘μ”μ„±

SNSμ MessageAttributesλ” ν•„ν„°λ§μ ν•µμ‹¬μ…λ‹λ‹¤. λ©”μ‹μ§€ λ³Έλ¬Έμ΄ μ•„λ‹ μ†μ„±μΌλ΅ ν•„ν„°λ§ν•λ―€λ΅ μ„±λ¥μ΄ μ°μν•©λ‹λ‹¤.

### 2. μ«μ μ΅°κ±΄ ν•„ν„°λ§

`{"numeric":[">=",100]}` ν•νƒλ΅ λ©”μ‹μ§€ μ†μ„±μ μ«μ κ°’μ— λ€ν• λ³µμ΅ν• μ΅°κ±΄λ„ μ„¤μ • κ°€λ¥ν•©λ‹λ‹¤.

### 3. Fan-out ν¨ν„΄μ ν¨μ¨μ„±

ν•λ‚μ λ©”μ‹μ§€λ¥Ό μ—¬λ¬ κµ¬λ…μμ—κ² μ „λ‹¬ν•λ, κ°μ ν•„μ”ν• κ²ƒλ§ λ°›μ„ μ μμ–΄ ν¨μ¨μ μ…λ‹λ‹¤.

### 4. LocalStackμ ν™μ©

μ‹¤μ  AWS λΉ„μ© μ—†μ΄ λ΅μ»¬μ—μ„ μ™„μ „ν• ν…μ¤νΈ ν™κ²½μ„ κµ¬μ¶•ν•  μ μμµλ‹λ‹¤.

## μ‹¤μ  μ΄μ μ‹ κ³ λ ¤μ‚¬ν•­

1. **μ—λ¬ ν•Έλ“¤λ§**: DLQ(Dead Letter Queue) μ„¤μ •
2. **λ¨λ‹ν„°λ§**: CloudWatch λ©”νΈλ¦­ ν™μ©
3. **λΉ„μ© μµμ ν™”**: ν•„ν„°λ§μΌλ΅ λ¶ν•„μ”ν• μ²λ¦¬ κ°μ†
4. **ν™•μ¥μ„±**: μƒλ΅μ΄ μ΅°κ±΄ μ¶”κ°€ μ‹ κΈ°μ΅΄ κµ¬λ…μμ— μν–¥ μ—†μ

## λ§λ¬΄λ¦¬

AWS SNSμ λ©”μ‹μ§€ ν•„ν„°λ§ κΈ°λ¥μ„ ν™μ©ν•λ©΄ λ³µμ΅ν• λ©”μ‹μ§€ λΌμ°ν… λ΅μ§μ„ κ°„λ‹¨ν•κ³  ν¨μ¨μ μΌλ΅ κµ¬ν„ν•  μ μμµλ‹λ‹¤. νΉν λ§μ΄ν¬λ΅μ„λΉ„μ¤ ν™κ²½μ—μ„ μ„λΉ„μ¤ κ°„ λμ¨ν• κ²°ν•©μ„ μ μ§€ν•λ©΄μ„λ„ μ •ν™•ν• λ©”μ‹μ§€ μ „λ‹¬μ΄ κ°€λ¥ν•©λ‹λ‹¤.

μ΄λ² μ‹¤μµμ„ ν†µν•΄ LocalStackμ„ ν™μ©ν• λ΅μ»¬ κ°λ° ν™κ²½ κµ¬μ¶•λ¶€ν„° μ‹¤μ  ν•„ν„°λ§ ν…μ¤νΈκΉμ§€ μ „ κ³Όμ •μ„ κ²½ν—ν•΄λ³Ό μ μμ—μµλ‹λ‹¤. μ‹¤μ  ν”„λ΅λ•μ… ν™κ²½μ—μ„λ„ λ™μΌν• μ›λ¦¬λ΅ μ μ©ν•  μ μμΌλ‹, μ—¬λ¬λ¶„μ ν”„λ΅μ νΈμ—λ„ ν™μ©ν•΄λ³΄μ‹κΈ° λ°”λλ‹λ‹¤!

---

_μ „μ²΄ μ†μ¤μ½”λ“λ” <a href="https://github.com/seongjin605/aws-fanout-pattern/tree/main" target="_blank">π”— GitHub μ €μ¥μ†</a>μ—μ„ ν™•μΈν•μ‹¤ μ μμµλ‹λ‹¤._
